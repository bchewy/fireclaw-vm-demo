# fireclaw

> Firecracker microVM control plane for isolated OpenClaw instances

`fireclaw` is a Bash + systemd CLI for provisioning and managing OpenClaw agents in Firecracker VMs. Install with `npm install -g fireclaw`, then run with `sudo fireclaw <command>`.

## Core architecture

Host:

- CLI entrypoint: `bin/fireclaw`
- VM lifecycle units: `firecracker-vmdemo-<id>.service`
- Localhost proxy units: `vmdemo-proxy-<id>.service`
- Network plumbing: bridge + NAT

Guest:

- cloud-init for bootstrapping user and base packages
- Docker configured for Firecracker constraints (`iptables=false`, `ip6tables=false`, `bridge=none`)
- `openclaw-<id>.service` systemd unit running containerized gateway

State split:

- Instance metadata/secrets: `/var/lib/fireclaw/.vm-<id>/`
- Firecracker runtime artifacts: `/srv/firecracker/vm-demo/<id>/`

## Commands

Top-level commands in `bin/fireclaw`:

- `setup`: create + provision new VM
- `provision`: re-run guest provisioning for existing VM
- `list`, `status`, `start`, `stop`, `restart`, `logs`, `shell`, `token`, `destroy`

Implementation files:

- `bin/vm-setup`: one-shot create/provision path
- `bin/vm-provision`: reprovision-only flow
- `bin/vm-ctl`: lifecycle and inspection commands
- `scripts/provision-guest.sh`: guest-side provisioning

## Shared shell library (`bin/vm-common.sh`)

Important helpers:

- Validation: `validate_instance_id`, `validate_host_port`
- Path/unit naming: `instance_dir`, `instance_env`, `instance_token`, `fc_instance_dir`, `vm_service`, `proxy_service`
- Allocation:
  - `next_port`: first free host port above `BASE_PORT` (skips assigned + in-use ports)
  - `ensure_host_port_available`: validates explicit user-chosen host port
  - `next_ip`: first free VM IP in configured `/24` subnet, reserving bridge gateway
- Network parsing: `subnet_mask_bits`, `subnet_prefix`, `bridge_gateway_ip`
- Connectivity/health: `wait_for_ssh`, `check_guest_health`

## `setup` flow highlights (`bin/vm-setup`)

1. Parse flags and validate required values.
2. Validate host dependencies.
3. Resolve host port (`--host-port` or automatic).
4. Resolve VM IP from `SUBNET_CIDR` + `BRIDGE_ADDR`.
5. Generate cloud-init and Firecracker config.
6. Create host systemd units for VM and proxy.
7. Boot VM, wait for SSH, run guest provision script.
8. Enable proxy and verify host/guest health.

Notable flags:

- `--host-port`
- `--disk-size`
- `--api-sock`
- `--base-kernel`, `--base-rootfs`, `--base-initrd`
- `--anthropic-api-key`, `--openai-api-key`, `--minimax-api-key`
- `--skip-browser-install`

## Networking model

Defaults:

- `BRIDGE_NAME=fc-br0`
- `BRIDGE_ADDR=172.16.0.1/24`
- `SUBNET_CIDR=172.16.0.0/24`
- `BASE_PORT=18890` (first auto proxy port is 18891)

OpenClaw gateway stays inside guest on `:18789`. Host proxy binds `127.0.0.1:<HOST_PORT>` and forwards to `<VM_IP>:18789`.

Automatic VM IP allocation currently supports `/24` subnets.

## Testing

`npm test` now runs both:

- Shell syntax checks (`npm run lint:shell`)
- Unit tests (`npm run test:unit`)

Unit tests live in `tests/unit/vm-common.test.sh` and validate allocation/network helper behavior plus core validators.

## Design decisions

- Keep control plane simple (Bash + systemd).
- Favor explicit, inspectable artifacts over hidden state stores.
- Keep API surface localhost-only by default.
- Support reprovisioning existing guests without recreating VMs.
